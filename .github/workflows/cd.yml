name: CD - Deploy to Server via SSH

on:
  push:
    branches: ["main"]  # main 브랜치 푸시 시 자동 배포
  workflow_dispatch:      # 수동 실행 지원

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub 저장소의 파일을 가져옵니다.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. docker-compose.backend.yml 파일을 EC2로 전송합니다.
      - name: Copy Docker Compose file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml"
          target: "~/deploy"

      # 3. SSH 접속 후 배포 명령을 실행합니다.
      - name: Connect & Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: | 
            set -e # 에러 발생 시 중단
            mkdir -p ~/deploy
            cd ~/deploy

            # 폴더 생성 및 이동
            mkdir -p ~/deploy
            mkdir -p logs
            chmod 777 logs

            # 1. 환경 변수(.env) 파일 생성
            cat > .env << 'ENVEOF'
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DJANGO_SETTINGS_MODULE=${{ secrets.DJANGO_SETTINGS_MODULE }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            DOCKER_HUB_USERNAME=${{ secrets.DOCKER_HUB_USERNAME }}
            ENVEOF

            # 2. 백엔드 서비스 이미지 Pull 및 실행
            # sudo 권한이 필요한 경우를 대비해 sudo를 붙였습니다.
            sudo docker compose -f docker-compose.yml pull
            sudo docker compose -f docker-compose.yml up -d

            # 3. 컨테이너 상태 확인
            sudo docker compose -f docker-compose.yml ps

            # 4. 사용하지 않는 구형 이미지 정리
            sudo docker image prune -f