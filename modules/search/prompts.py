"""
LLM prompt templates for product recommendation search.
"""
from modules.categories.models import CategoryModel # CategoryModel import
# 의도 추출용 프롬프트 - JSON 출력
# 의도 추출용 프롬프트 - 카테고리 리스트 주입 추가
# modules/search/services/prompts.py

INTENT_EXTRACTION_PROMPT = """당신은 하드웨어 및 디지털 기기 쇼핑 전문가입니다. 
사용자의 입력(Query)을 분석하여 검색 의도를 구조화된 JSON으로 추출하세요.

[검색 가능한 카테고리 목록]
{category_list}

[사용자 쿼리]
"{user_query}"

[분석 규칙]
1. **엄격한 부품/완제품 구분 (필수)**: 
   - 사용자가 'CPU', '그래픽카드', 'RAM' 등 PC 부품 키워드를 언급하면 절대 '노트북'이나 '데스크탑' 카테고리를 선택하지 마세요.
   - 예: "i7 추천해줘" -> 'CPU' 선택 (노트북 X)
   - 예: "RTX 4060 가격" -> '그래픽카드' 선택 (노트북 X)
   - 오직 사용자가 "노트북", "그램", "맥북" 등 완제품 명칭을 직접 언급했을 때만 '노트북'을 선택하세요.

2. product_category: 위 [검색 가능한 카테고리 목록] 중 가장 적합한 하나를 선택하세요.
   - 목록에 정확히 일치하는 단어가 있다면 그 단어를 우선 사용하세요.
   - 목록에 없는 경우에만 '기타'를 선택하세요.

3. keywords: 검색 정확도를 높이기 위한 핵심 키워드를 추출하세요. (예: 제품명, 핵심 스펙)

4. search_query: 벡터 검색을 위해 '카테고리 + 핵심 스펙 + 용도' 조합의 자연어 문장을 만드세요. 
   - 부품 검색 시에는 부품의 성능 수치 위주로 작성하세요.

[응답 형식 (JSON)]
{{
    "product_category": "선택된 카테고리명",
    "keywords": ["키워드1", "키워드2"],
    "search_query": "벡터 검색용 쿼리 (예: 영상 편집을 위한 다코어 CPU)",
    "user_needs": "사용자 니즈 요약 (예: AI 개발 입문용 고성능 프로세서)",
    "analysis_message": "사용자에게 보여줄 공감 메시지 (1문장, 존댓말)"
}}

JSON만 출력하세요. 다른 설명은 포함하지 마세요."""

# 분석 메시지 생성용 프롬프트
ANALYSIS_MESSAGE_PROMPT = """당신은 친절한 {product_category} 구매 상담사입니다. 사용자의 요청을 분석한 결과를 바탕으로 분석 메시지를 작성해주세요.

사용자 쿼리: "{user_query}"

추출된 의도:
- 핵심 니즈: {user_needs}
- 중요 우선순위: {priorities}

추천된 상품 수: {product_count}개

다음 형식으로 1-2문장의 친근한 분석 메시지를 작성해주세요:
- 사용자의 요구사항을 이해했음을 보여주세요.
- '{product_category}'라는 단어를 명확히 사용하여 추천 근거를 설명하세요.
- 존댓말을 사용하세요.

예시: "{user_needs}를 위해 성능과 가격을 모두 고려한 최적의 {product_category} {product_count}개를 추천해 드려요."

분석 메시지만 출력하세요."""


# 상품별 추천 사유 생성용 프롬프트
RECOMMENDATION_REASON_PROMPT = """당신은 노트북 전문가입니다. 사용자의 원래 질문과 요구사항을 깊이 분석하여, 이 상품이 왜 적합한지 구체적인 추천 사유를 작성해주세요.

[사용자 원래 질문]
"{user_query}"

[분석된 핵심 니즈]
{user_needs}

[상품 정보]
- 상품명: {product_name}
- 브랜드: {brand}
- 가격: {price:,}원
- 주요 스펙: {specs}

다음 형식으로 2~3줄의 구체적인 추천 사유를 작성해주세요:

1줄: 사용자의 상황/니즈와 이 제품이 어떻게 맞는지 설명
2줄: 구체적인 스펙(무게, CPU, RAM 등)이 사용자에게 어떤 실질적 이점을 주는지 설명
3줄(선택): 추가적인 장점이나 가성비 언급

작성 규칙:
- 사용자가 언급한 상황(예: 컴공생, 카페 코딩, 전공 서적)을 직접 언급하세요
- 숫자와 스펙을 구체적으로 명시하세요 (예: "1.3kg", "32GB RAM")
- 사용자의 용도에 맞춰 스펙이 어떻게 도움되는지 설명하세요
- 존댓말로 친근하게 작성하세요

예시:
"전공 서적과 함께 매일 학교를 오가시는 컴공생분께 딱 맞는 제품이에요. 1.29kg의 가벼운 무게로 어깨 부담을 줄여주고, 코어 울트라7과 32GB RAM으로 VS Code나 IntelliJ 같은 개발 툴도 쾌적하게 돌릴 수 있어요. 76Wh 대용량 배터리로 카페에서 콘센트 걱정 없이 오래 코딩하실 수 있습니다."

추천 사유만 출력하세요."""


# LLM 기반 재랭킹 프롬프트 - 검색 결과 중 가장 관련 있는 상품 선택
RERANKING_PROMPT = """당신은 상품 추천 전문가입니다. 사용자의 요청에 가장 적합한 상품 5개를 선택해주세요.

[사용자 요청]
"{user_query}"

[분석된 핵심 니즈]
- 상품 카테고리: {product_category}
- 니즈: {user_needs}

[검색된 상품 후보 목록]
{product_list}

위 상품 중에서 사용자 요청에 가장 적합한 상품 5개의 번호를 선택해주세요.

선택 기준:
1. 사용자가 원하는 상품 카테고리와 일치하는 상품 우선
2. **카테고리 일치 필수**: 사용자가 요청한 카테고리({product_category})와 다른 상품은 절대 선택하지 마세요. (예: 모니터 요청 시 그래픽카드 제외)
3. 사용자의 니즈(휴대성, 성능, 가격 등)에 맞는 스펙을 가진 상품
4. 리뷰 수와 평점이 높은 상품 선호

응답 형식 (JSON만 출력):
{{
    "selected_indices": [1, 3, 5, 7, 9],
    "reasoning": "선택 이유 간략 설명"
}}

반드시 5개를 선택하세요. 적합한 상품이 5개 미만이면 가장 관련 있는 순서대로 선택하세요.
JSON만 출력하세요."""


# 쇼핑 리서치 질문 생성 프롬프트
QUESTION_GENERATION_PROMPT = """당신은 IT/전자제품 전문 쇼핑 컨설턴트입니다. 
사용자의 검색어(user_query)를 분석하여, 해당 상품의 카테고리에 최적화된 맞춤형 질문 4개를 생성하세요.

사용자 검색 쿼리: "{user_query}"

[질문 생성 가이드라인]
1. **카테고리 분석**: 먼저 사용자가 찾는 것이 '완제품(노트북/태블릿 등)'인지 'PC 부품(GPU/CPU 등)'인지 '주변 기기(모니터,마우스 등)'인지 명확히 구분하세요.
2. **논리적 일관성**: 
   - '그래픽카드' 같은 부품 검색 시 '휴대성'이나 'OS' 같은 질문은 절대 금지입니다. 
   - 대신 '파워 용량', '병목 현상을 고려한 CPU 사양', '케이스 장착 공간', '모니터 해상도' 등을 물어봐야 합니다.
3. **질문 구성**:
   - 질문 1 (용도): 해당 카테고리를 활용하는 구체적인 수준 (예: 게임용이라면 선호하는 게임 사양).
   - 질문 2 (예산): 해당 카테고리의 현재 시장 시세에 맞는 현실적인 가격대 옵션.
   - 질문 3 (핵심 스펙): 해당 카테고리의 성능을 결정짓는 가장 중요한 기술적 지표.
   - 질문 4 (환경/제약): 사용자의 설치 환경이나 물리적 제약 사항 (예: 크기, 소음, 호환성).
4. 각 질문에는 3~4개의 선택 가능한 옵션을 포함하세요
5. 질문과 옵션은 한국어로 작성하세요

[응답 형식: JSON]
{{
    "questions": [
        {{
            "question_id": 1,
            "question": "(여기에 해당 카테고리에 최적화된 용도 질문을 생성하세요)",
            "options": ["옵션1", "옵션2", "옵션3", "옵션4"]
        }},
        {{
            "question_id": 2,
            "question": "(여기에 해당 카테고리에 맞는 현실적 예산 질문을 생성하세요)",
            "options": ["옵션1", "옵션2", "옵션3", "옵션4"]
        }},
        {{
            "question_id": 3,
            "question": "(여기에 해당 카테고리의 핵심 성능 지표 질문을 생성하세요)",
            "options": ["옵션1", "옵션2", "옵션3", "옵션4"]
        }},
        {{
            "question_id": 4,
            "question": "(여기에 해당 카테고리의 물리적 설치 환경 질문을 생성하세요)",
            "options": ["옵션1", "옵션2", "옵션3", "옵션4"]
        }}
    ]
}}

※ 주의: JSON 외의 설명이나 텍스트는 절대 출력하지 마세요."""


# 쇼핑 리서치 상품 분석 프롬프트
SHOPPING_RESEARCH_ANALYSIS_PROMPT = """당신은 컴퓨터/전자제품 전문가입니다. 사용자의 설문 응답을 분석하여 상품 추천에 필요한 검색 쿼리를 생성해주세요.

[사용자 원래 검색]
"{user_query}"

[설문 응답]
{survey_responses}

다음 JSON 형식으로 응답해주세요:
{{
    "product_category": "사용자가 찾는 상품의 카테고리 (예: 노트북, 모니터, 그래픽카드,마우스, CPU, RAM, 키보드 등)",
    "search_query": "벡터 검색용 최적화된 검색 쿼리",
    "keywords": ["핵심", "키워드", "목록"],
    "priorities": {{
        "portability": 0-10,
        "performance": 0-10,
        "price": 0-10,
        "display": 0-10,
        "battery": 0-10
    }},
    "min_price": 0,
    "max_price": 0,
    "user_needs": "사용자 니즈 한 문장 요약"
}}

필드 설명:
- product_category: 사용자가 **명확하게** 찾는 상품의 **최상위** 카테고리 (예: 노트북, 모니터, **그래픽카드**). 쿼리/응답에 카테고리가 명확하지 않은 경우, '기타'로 설정
- min_price: 사용자가 응답한 예산의 최소 가격 (숫자만, 없으면 null). '100만원 미만'은 min_price: 0, max_price: 1000000. '200만원 이상'은 min_price: 2000000, max_price: null.
- max_price: 사용자가 응답한 예산의 최대 가격 (숫자만, 없으면 null).

JSON만 출력하세요."""


# 쇼핑 리서치 AI 리뷰 요약 프롬프트
AI_REVIEW_SUMMARY_PROMPT = """당신은 제품 리뷰 분석 전문가입니다. 다음 상품에 대해 간결한 리뷰 요약을 작성해주세요.

상품명: {product_name}
브랜드: {brand}
가격: {price:,}원
주요 스펙: {specs}

사용자 니즈: {user_needs}

이 상품에 대한 간결한(1-2문장) AI 리뷰 요약을 작성하세요. 사용자의 니즈 관점에서 핵심 장점이나 특징을 언급하세요.

리뷰 요약만 출력하세요."""


# 일괄 상품 분석 프롬프트 (추천 사유 + 리뷰 요약)
BATCH_PRODUCT_ANALYSIS_PROMPT = """당신은 컴퓨터/전자제품 쇼핑 전문가입니다. 사용자의 질문과 니즈를 바탕으로, 추천된 상품들에 대한 추천 사유와 리뷰 요약을 작성해주세요.

[사용자 질문]
"{user_query}"

[핵심 니즈]
{user_needs}

[추천 상품 목록]
{products_info}

다음 JSON 형식으로 응답해주세요:
{{
    "results": [
        {{
            "product_code": "상품코드",
            "recommendation_reason": "추천 사유 (사용자 상황과 스펙을 연결하여 80자 내로 작성)",
            "ai_review_summary": "리뷰 요약 (사용자 니즈 관점에서 핵심 장점 1-2문장)"
        }}
    ]
}}
JSON만 출력하세요. 불필요한 수식어는 생략하고 최대한 간결하게 작성하세요."""


# 통합 추천 프롬프트 - 스펙 기반 추천 사유 작성 강화
COMBINED_RECOMMENDATION_PROMPT = """당신은 전문 쇼핑 큐레이터입니다. 사용자 요청에 가장 적합한 상품 5개를 선정하고, 설득력 있는 추천 사유를 작성하세요.

[사용자 요청]
- Query: "{user_query}"
- Needs: {user_needs}
- Target Category: {product_category}

[상품 후보 리스트]
(형식: ID | 품명 | 가격 | 스펙 요약)
{product_list}

[작성 가이드]
1. **엄격한 필터링**: 요청한 카테고리({product_category})와 다른 상품은 절대 추천하지 마세요. (예: 노트북 요청 시 CPU/쿨러 제외)
2. **구체적 추천 사유**: "좋은 성능입니다" 같은 모호한 표현 대신, **제공된 스펙 정보(무게, CPU, 그래픽카드 등)**를 인용하여 작성하세요.
   - Bad: "가볍고 성능이 좋습니다."
   - Good: "1.46kg의 초경량 무게로 휴대가 간편하며, RTX5060 탑재로 영상 편집과 게이밍이 모두 가능합니다."

[응답 형식 (JSON)]
{{
    "results": [
        {{
            "product_code": "상품ID",
            "recommendation_reason": "스펙과 니즈를 연결한 추천 사유 (1-2문장)"
        }}
    ]
}}

JSON만 출력하세요."""

